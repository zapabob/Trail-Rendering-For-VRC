// TrailRendererBase.cs
using UnityEngine;
using VRC.SDK3.Avatars.Components;
using VRC.SDK3.Avatars.ScriptableObjects;

public abstract class TrailRendererBase : MonoBehaviour
{
    [SerializeField] protected LineRenderer[] lineRenderers;
    [SerializeField] protected float minTrailDuration = 0.3f;
    [SerializeField] protected float maxTrailDuration = 0.7f;
    [SerializeField] protected float minTrailWidth = 0.005f;
    [SerializeField] protected float maxTrailWidth = 0.015f;
    [SerializeField] protected Gradient defaultTrailColorGradient;
    [SerializeField] protected VRCExpressionParameters expressionParameters;
    [SerializeField] protected VRCAvatarDescriptor avatarDescriptor;
    [SerializeField] protected string[] boneNames;

    protected Animator animator;

    protected virtual void Start()
    {
        SetupComponents();
    }

    protected virtual void SetupComponents()
    {
        animator = GetComponentInParent<Animator>();
        if (animator == null)
        {
            throw new InvalidOperationException("Animator component not found on the avatar.");
        }

        if (expressionParameters == null)
        {
            throw new InvalidOperationException("VRCExpressionParameters not assigned.");
        }

        if (avatarDescriptor == null)
        {
            throw new InvalidOperationException("VRCAvatarDescriptor not assigned.");
        }

        for (int i = 0; i < boneNames.Length; i++)
        {
            SetupLineRenderer(lineRenderers[i], boneNames[i]);
        }
    }

    protected virtual void SetupLineRenderer(LineRenderer lineRenderer, string boneName)
    {
        if (lineRenderer == null)
        {
            lineRenderer = GetLineRendererForBone(boneName);
            if (lineRenderer == null)
            {
                throw new InvalidOperationException($"LineRenderer not found for bone '{boneName}'.");
            }
        }

        lineRenderer.material = new Material(Shader.Find("Unlit/Color"));
    }

    protected virtual LineRenderer GetLineRendererForBone(string boneName)
    {
        var boneTransform = animator.GetBoneTransform(HumanBodyBones.Hips).Find(boneName);
        if (boneTransform == null)
        {
            throw new InvalidOperationException($"Bone '{boneName}' not found.");
        }

        return boneTransform.GetComponentInChildren<LineRenderer>();
    }

    protected abstract void UpdateTrail(LineRenderer lineRenderer, string boneName);
    protected abstract void UpdateTrailParameters();
}
